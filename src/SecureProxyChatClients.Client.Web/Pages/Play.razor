@page "/play"
@using SecureProxyChatClients.Client.Web.Components
@using SecureProxyChatClients.Client.Web.Services
@using SecureProxyChatClients.Shared.Contracts
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject AuthState AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>âš”ï¸ Play â€” LoreEngine</PageTitle>

@if (!AuthState.IsAuthenticated)
{
    <div class="alert alert-warning" data-testid="play-unauthenticated">
        You must <a href="/login">login</a> to begin your adventure.
    </div>
}
else if (isLoading && playerState is null)
{
    <div class="text-center py-5" data-testid="play-loading">
        <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading your adventure...</p>
    </div>
}
else if (playerState is null)
{
    <!-- Character Creation -->
    <div class="text-center mb-4" data-testid="character-creation">
        <pre class="ascii-art" style="display: inline-block; text-align: left;">
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘     âš”ï¸  THE LOREENGINE  âš”ï¸          â•‘
  â•‘                                      â•‘
  â•‘   "Every legend begins with a        â•‘
  â•‘    single step into the unknown..."  â•‘
  â•‘                                      â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        </pre>
        <h2 style="font-family: var(--font-display); color: var(--lore-gold);">Create Your Character</h2>
        <hr class="lore-separator" />
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="mb-4">
                <label class="form-label">Character Name</label>
                <input type="text" class="form-control form-control-lg" @bind="characterName" @bind:event="oninput"
                       placeholder="Enter your hero's name..." maxlength="30"
                       data-testid="character-name" />
            </div>

            <label class="form-label">Choose Your Class</label>
            <div class="row g-3 mb-4">
                @foreach (var cls in characterClasses)
                {
                    <div class="col-6">
                        <div class="card h-100 class-card @(selectedClass == cls.Key ? "border-primary glow-active" : "")"
                             style="cursor: pointer;"
                             @onclick="() => selectedClass = cls.Key"
                             data-testid="class-@cls.Key">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div style="font-size: 2.5em; min-width: 50px; text-align: center;">@cls.Value.Emoji</div>
                                <div>
                                    <h5 class="mb-1" style="font-family: var(--font-display); color: var(--lore-gold-bright);">@cls.Value.Name</h5>
                                    <div class="text-muted" style="font-size: 0.9rem;">@cls.Value.Description</div>
                                    <div class="mt-1" style="font-size: 0.75rem; font-family: var(--font-mono); color: var(--lore-text-dim);">@cls.Value.Stats</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="text-center">
                <button class="btn btn-primary btn-lg" @onclick="StartNewGame"
                        disabled="@(string.IsNullOrWhiteSpace(characterName) || selectedClass is null)"
                        data-testid="start-game">
                    âš”ï¸ Begin Your Adventure
                </button>
            </div>
        </div>
    </div>
}
else if (playerState is not null)
{
    <!-- Game UI -->
    <div class="d-flex gap-2" style="max-width: 100%; overflow: hidden;" data-testid="play-container">
        <!-- Main game area -->
        <div class="flex-grow-1" style="min-width: 0;">
            <!-- Player stats bar -->
            <div class="player-stats mb-3" data-testid="player-stats">
                <span class="stat-badge">âš”ï¸</span>
                <span class="stat-value" style="color: var(--lore-gold-bright);">@playerState.Name</span>
                <span class="stat-dim">@playerState.CharacterClass</span>
                <span class="stat-sep">â”‚</span>
                <span class="stat-label">LVL</span>
                <span class="stat-value stat-xp">@playerState.Level</span>
                <span class="stat-sep">â”‚</span>
                <span class="stat-label">HP</span>
                <span class="stat-value stat-hp">@playerState.Health/@playerState.MaxHealth</span>
                <div class="health-bar">
                    <div class="health-bar-fill" style="width: @(playerState.MaxHealth > 0 ? (int)(100.0 * playerState.Health / playerState.MaxHealth) : 0)%"></div>
                </div>
                <span class="stat-sep">â”‚</span>
                <span class="stat-value stat-gold">ğŸ’°@playerState.Gold</span>
                <span class="stat-value stat-xp">âœ¨@playerState.Experience</span>
                <span class="ms-auto stat-value">ğŸ“ @playerState.CurrentLocation</span>
            </div>

            <!-- Combat Tracker -->
            @if (activeCombat is not null)
            {
                <div class="combat-tracker mb-2" data-testid="combat-tracker">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-family: var(--font-display); color: var(--lore-crimson); font-size: 0.9rem;">
                            âš”ï¸ COMBAT â€” Turn @combatTurn
                        </span>
                        <button class="btn btn-outline-secondary btn-sm" style="font-size: 0.7rem; padding: 2px 8px;"
                                @onclick="() => activeCombat = null">âœ• End</button>
                    </div>
                    <div class="combat-combatant enemy">
                        <span class="combat-emoji">@activeCombat.Emoji</span>
                        <span class="combat-name">@activeCombat.Name</span>
                        <span class="combat-level">Lvl @activeCombat.Level</span>
                    </div>
                    <div class="combat-combatant player">
                        <span class="combat-emoji">ğŸ›¡ï¸</span>
                        <span class="combat-name">@playerState.Name</span>
                        <div class="combat-hp-bar">
                            <div class="combat-hp-fill" style="width: @(playerState.MaxHealth > 0 ? (int)(100.0 * playerState.Health / playerState.MaxHealth) : 0)%"></div>
                        </div>
                        <span class="combat-hp-text">@playerState.Health/@playerState.MaxHealth</span>
                    </div>
                </div>
            }

            <!-- Game events (dice rolls, items, etc.) -->
            @if (gameEvents.Count > 0)
            {
                <div class="mb-2" data-testid="game-events">
                    @foreach (var evt in gameEvents.TakeLast(5))
                    {
                        <div class="play-dice @GetEventClass(evt) mb-1">
                            @GetEventDisplay(evt)
                        </div>
                    }
                </div>
            }

            <!-- Story area -->
            <div id="story-area" class="story-area" style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;" data-testid="story-area">
                @foreach (var msg in storyMessages)
                {
                    <GameMessage Content="@msg.Content" Role="@msg.Role" />
                }

                @if (isStreaming && !string.IsNullOrEmpty(streamingContent))
                {
                    <div class="play-scene streaming">
                        <span>@streamingContent</span>
                        <span class="typing-cursor"></span>
                    </div>
                }
            </div>

            <hr class="lore-separator my-2" />

            <!-- Action input -->
            <div class="d-flex gap-2" data-testid="action-input">
                <input type="text" class="form-control" placeholder="What do you do?"
                       @bind="actionInput" @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       disabled="@isStreaming"
                       data-testid="action-text" />
                <button class="btn btn-primary px-4" @onclick="SendAction"
                        disabled="@(isStreaming || string.IsNullOrWhiteSpace(actionInput))"
                        data-testid="send-action">
                    âš”ï¸ Act
                </button>
            </div>

            <!-- Quick actions â€” grouped by type -->
            <div class="d-flex gap-2 mt-2 flex-wrap align-items-center">
                <span class="text-muted" style="font-size: 0.7rem; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 0.1em;">Actions:</span>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => QuickAction("Look around and describe what I see"))"
                        disabled="@isStreaming">ğŸ‘ï¸ Look</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => QuickAction("Check my inventory and equipment"))"
                        disabled="@isStreaming">ğŸ’ Inventory</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => QuickAction("Talk to whoever is nearby"))"
                        disabled="@isStreaming">ğŸ’¬ Talk</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => QuickAction("Search the area carefully for anything useful"))"
                        disabled="@isStreaming">ğŸ” Search</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="@(() => QuickAction("Rest and recover some health"))"
                        disabled="@isStreaming">ğŸ’¤ Rest</button>
                <span class="text-muted mx-1">|</span>
                <button class="btn btn-outline-warning btn-sm" @onclick="TriggerTwistOfFate"
                        disabled="@isStreaming" title="Something unexpected happens...">ğŸŒ€ Twist</button>
                <button class="btn btn-outline-danger btn-sm" @onclick="TriggerEncounter"
                        disabled="@isStreaming" title="Fight a random creature!">âš”ï¸ Fight</button>
                <button class="btn btn-outline-info btn-sm" @onclick="ConsultOracle"
                        disabled="@isStreaming" title="Ask the Oracle for a cryptic hint...">ğŸ‘ï¸ Oracle</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="ShowMap"
                        disabled="@isStreaming" title="View the world map">ğŸ—ºï¸ Map</button>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-2" data-testid="play-error">@errorMessage</div>
            }
        </div>

        <!-- Inventory sidebar -->
        <div class="inventory-sidebar" style="width: 200px; flex-shrink: 0;" data-testid="inventory-sidebar">
            <div class="card">
                <div class="card-header">ğŸ’ Inventory</div>
                <div class="card-body py-2">
                    @if (playerState.Inventory.Count == 0)
                    {
                        <small class="text-muted">Empty</small>
                    }
                    else
                    {
                        @foreach (var item in playerState.Inventory)
                        {
                            <div class="inventory-item" title="@item.Description">
                                @item.Emoji @item.Name
                                @if (item.Quantity > 1) { <small class="text-muted">x@(item.Quantity)</small> }
                            </div>
                        }
                    }
                </div>
            </div>

            <div class="card mt-2">
                <div class="card-header">ğŸ“Š Stats</div>
                <div class="card-body py-2" style="font-family: var(--font-mono); font-size: 0.8rem;">
                    @foreach (var stat in playerState.Stats)
                    {
                        <div class="d-flex justify-content-between">
                            <span class="text-muted text-uppercase">@stat.Key[..3]</span>
                            <span>@stat.Value</span>
                        </div>
                    }
                </div>
            </div>

            <button class="btn btn-outline-secondary btn-sm w-100 mt-2" @onclick="StartOver" data-testid="new-game-btn">
                ğŸ”„ New Game
            </button>
        </div>
    </div>
}
else
{
    <div class="text-center mt-4">
        <span class="spinner-border" role="status"></span>
        <p class="mt-2 text-muted">Loading your adventure...</p>
    </div>
}

@code {
    private PlayerStateDto? playerState;
    private List<ChatMessageDto> storyMessages = [];
    private List<GameEvent> gameEvents = [];
    private string actionInput = string.Empty;
    private string? errorMessage;
    private bool isStreaming;
    private bool isLoading;
    private string streamingContent = string.Empty;
    private string? sessionId;

    // Combat state
    private EncounterData? activeCombat;
    private int combatTurn;

    // Character creation
    private string characterName = string.Empty;
    private string? selectedClass;

    private static readonly Dictionary<string, ClassInfo> characterClasses = new()
    {
        ["warrior"] = new("Warrior", "âš”ï¸", "Strength and steel", "STR 14 | DEX 10"),
        ["rogue"] = new("Rogue", "ğŸ—¡ï¸", "Stealth and cunning", "DEX 14 | CHA 12"),
        ["mage"] = new("Mage", "ğŸ”®", "Arcane power", "WIS 14 | CHA 12"),
        ["explorer"] = new("Explorer", "ğŸ§­", "Resourceful and adaptable", "Balanced stats"),
    };

    private sealed record ClassInfo(string Name, string Emoji, string Description, string Stats);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthState.InitializeAsync();
            if (AuthState.IsAuthenticated)
            {
                isLoading = true;
                StateHasChanged();
                await LoadPlayerState();
                isLoading = false;
            }
            StateHasChanged();
        }
    }

    private async Task LoadPlayerState()
    {
        try
        {
            var state = await Http.GetFromJsonAsync<PlayerStateDto>("/api/play/state");
            if (state is not null && state.Name != "Adventurer")
            {
                playerState = state;
                // Load a welcome back message
                storyMessages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = $"Welcome back, {state.Name} the {state.CharacterClass}. You find yourself at {state.CurrentLocation}.\n\nWhat do you do?",
                });
            }
        }
        catch { /* No existing game, show character creation */ }
    }

    private async Task StartNewGame()
    {
        if (string.IsNullOrWhiteSpace(characterName) || selectedClass is null) return;

        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("/api/play/new-game", new
            {
                characterName,
                characterClass = selectedClass,
            });

            if (response.IsSuccessStatusCode)
            {
                playerState = await response.Content.ReadFromJsonAsync<PlayerStateDto>();
                storyMessages.Clear();
                gameEvents.Clear();

                // Send the opening prompt
                await SendActionInternal("I arrive at the crossroads. Describe the scene and what I see.", showUserMessage: false);
            }
            else
            {
                errorMessage = "Failed to start game.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isStreaming && !string.IsNullOrWhiteSpace(actionInput))
            await SendAction();
    }

    private async Task SendAction()
    {
        if (string.IsNullOrWhiteSpace(actionInput)) return;
        await SendActionInternal(actionInput);
        actionInput = string.Empty;
    }

    private async Task QuickAction(string action)
    {
        await SendActionInternal(action);
    }

    private async Task TriggerTwistOfFate()
    {
        try
        {
            var twist = await Http.GetFromJsonAsync<TwistData>("/api/play/twist");
            if (twist is not null)
            {
                await SendActionInternal($"[TWIST OF FATE: {twist.Emoji} {twist.Title}] {twist.Prompt}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"The fates are silent: {ex.Message}";
        }
    }

    private sealed class TwistData
    {
        public string Title { get; set; } = "";
        public string Prompt { get; set; } = "";
        public string Emoji { get; set; } = "";
        public string Category { get; set; } = "";
    }

    private async Task TriggerEncounter()
    {
        try
        {
            var encounter = await Http.GetFromJsonAsync<EncounterData>("/api/play/encounter");
            if (encounter is not null)
            {
                activeCombat = encounter;
                combatTurn = 1;
                gameEvents.Add(new GameEvent { Type = "Encounter", Data = JsonSerializer.SerializeToElement(new { Name = encounter.Name, Emoji = encounter.Emoji, Level = encounter.Level }) });
                await SendActionInternal(encounter.Prompt, showUserMessage: false);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"No creatures nearby: {ex.Message}";
        }
    }

    private sealed class EncounterData
    {
        public string Name { get; set; } = "";
        public string Emoji { get; set; } = "";
        public int Level { get; set; }
        public string Prompt { get; set; } = "";
    }

    private async Task ConsultOracle()
    {
        try
        {
            var lastUserMessage = storyMessages.LastOrDefault(m => m.Role == "user")?.Content ?? "What should I do next?";
            var response = await Http.PostAsJsonAsync("/api/play/oracle", new { question = lastUserMessage });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<OracleResponse>();
                if (result?.Oracle is not null)
                {
                    storyMessages.Add(new ChatMessageDto { Role = "assistant", Content = $"ğŸ‘ï¸ *{result.Oracle}*" });
                    StateHasChanged();
                    await ScrollStoryToBottom();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"The Oracle's vision is clouded: {ex.Message}";
        }
    }

    private sealed class OracleResponse
    {
        public string? Oracle { get; set; }
    }

    private async Task ShowMap()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<MapResponse>("/api/play/map");
            if (result is not null)
            {
                storyMessages.Add(new ChatMessageDto
                {
                    Role = "assistant",
                    Content = $"```ascii\n{result.Map}```\nYou can travel to: {string.Join(", ", result.Connections)}\n\n*({result.Explored}/{result.Total} locations explored)*",
                });
                StateHasChanged();
                await ScrollStoryToBottom();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Map unavailable: {ex.Message}";
        }
    }

    private sealed class MapResponse
    {
        public string Map { get; set; } = "";
        public List<string> Connections { get; set; } = [];
        public int Explored { get; set; }
        public int Total { get; set; }
    }

    private async Task SendActionInternal(string action, bool showUserMessage = true)
    {
        if (showUserMessage)
        {
            storyMessages.Add(new ChatMessageDto { Role = "user", Content = action });
        }
        errorMessage = null;
        isStreaming = true;
        streamingContent = string.Empty;
        StateHasChanged();

        try
        {
            var request = new ChatRequest
            {
                Messages = storyMessages.TakeLast(20).ToList(),
                SessionId = sessionId,
            };

            var jsonContent = JsonContent.Create(request);
            var httpRequest = new HttpRequestMessage(HttpMethod.Post, "/api/play/stream")
            {
                Content = jsonContent,
            };

            using var response = await Http.SendAsync(httpRequest);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error {(int)response.StatusCode}";
                return;
            }

            var sseText = await response.Content.ReadAsStringAsync();
            ParsePlaySseResponse(sseText);

            if (!string.IsNullOrEmpty(streamingContent))
            {
                storyMessages.Add(new ChatMessageDto { Role = "assistant", Content = streamingContent.Trim() });
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isStreaming = false;
            streamingContent = string.Empty;
            StateHasChanged();
            await ScrollStoryToBottom();
        }
    }

    private void ParsePlaySseResponse(string sseText)
    {
        string? eventType = null;
        foreach (var line in sseText.Split('\n'))
        {
            if (line.StartsWith("event: "))
            {
                eventType = line[7..].Trim();
            }
            else if (line.StartsWith("data: ") && eventType is not null)
            {
                var data = line[6..].Trim();

                switch (eventType)
                {
                    case "text-delta":
                        var json = JsonSerializer.Deserialize<JsonElement>(data);
                        if (json.TryGetProperty("text", out var textElement))
                            streamingContent += textElement.GetString();
                        break;

                    case "state":
                        var state = JsonSerializer.Deserialize<PlayerStateDto>(data, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                        if (state is not null)
                            playerState = state;
                        break;

                    case "done":
                        var doneJson = JsonSerializer.Deserialize<JsonElement>(data);
                        if (doneJson.TryGetProperty("sessionId", out var sidEl))
                            sessionId ??= sidEl.GetString();
                        break;
                }

                eventType = null;
            }
        }
    }

    private void StartOver()
    {
        playerState = null;
        isLoading = false;
        isStreaming = false;
        activeCombat = null;
        combatTurn = 0;
        storyMessages.Clear();
        gameEvents.Clear();
        sessionId = null;
        characterName = string.Empty;
        selectedClass = null;
    }

    private static string GetEventClass(GameEvent evt)
    {
        if (evt.Type == "Achievement") return "achievement";
        if (evt.Data is null) return "";
        try
        {
            if (evt.Type.Contains("RollCheck", StringComparison.OrdinalIgnoreCase) &&
                evt.Data.Value.TryGetProperty("Success", out var s))
                return s.GetBoolean() ? "success" : "failure";
        }
        catch { }
        return "";
    }

    private static string GetEventDisplay(GameEvent evt)
    {
        if (evt.Data is null) return evt.Type;
        try
        {
            return evt.Type switch
            {
                "RollCheck" => FormatDiceRoll(evt.Data.Value),
                "GiveItem" => $"ğŸ“¦ Found: {evt.Data.Value.GetProperty("Name").GetString()}",
                "TakeItem" => $"ğŸ“¦ Lost: {evt.Data.Value.GetProperty("Name").GetString()}",
                "ModifyHealth" => FormatHealthChange(evt.Data.Value),
                "ModifyGold" => FormatGoldChange(evt.Data.Value),
                "MovePlayer" => $"ğŸ“ Moved to: {evt.Data.Value.GetProperty("Location").GetString()}",
                "Encounter" => $"âš”ï¸ Encounter: {evt.Data.Value.GetProperty("Emoji").GetString()} {evt.Data.Value.GetProperty("Name").GetString()} (Lvl {evt.Data.Value.GetProperty("Level").GetInt32()})",
                "Achievement" => $"ğŸ† Achievement Unlocked: {evt.Data.Value.GetProperty("Emoji").GetString()} {evt.Data.Value.GetProperty("Title").GetString()}",
                _ => evt.Type,
            };
        }
        catch { return evt.Type; }
    }

    private static string FormatDiceRoll(JsonElement data)
    {
        int roll = data.GetProperty("Roll").GetInt32();
        int total = data.GetProperty("Total").GetInt32();
        int dc = data.GetProperty("Difficulty").GetInt32();
        bool success = data.GetProperty("Success").GetBoolean();
        bool crit = data.TryGetProperty("CriticalSuccess", out var cs) && cs.GetBoolean();
        bool critFail = data.TryGetProperty("CriticalFailure", out var cf) && cf.GetBoolean();

        string result = crit ? "CRITICAL SUCCESS!" : critFail ? "CRITICAL FAILURE!" : success ? "Success" : "Failure";
        return $"ğŸ² d20={roll} +{data.GetProperty("Modifier").GetInt32()} = {total} vs DC {dc} â†’ {result}";
    }

    private static string FormatHealthChange(JsonElement data)
    {
        int amount = data.GetProperty("Amount").GetInt32();
        return amount >= 0 ? $"ğŸ’š +{amount} HP ({data.GetProperty("Source").GetString()})" : $"ğŸ’” {amount} HP ({data.GetProperty("Source").GetString()})";
    }

    private static string FormatGoldChange(JsonElement data)
    {
        int amount = data.GetProperty("Amount").GetInt32();
        return amount >= 0 ? $"ğŸ’° +{amount} gold" : $"ğŸ’° {amount} gold";
    }

    private async Task ScrollStoryToBottom()
    {
        try
        {
            await Task.Yield(); // Let Blazor complete rendering
            await JS.InvokeVoidAsync("eval", "(() => { const el = document.getElementById('story-area'); if(el) el.scrollTop = el.scrollHeight; })()");
        }
        catch { /* JS interop may fail during dispose */ }
    }
}
